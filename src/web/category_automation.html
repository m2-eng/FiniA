<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiniA - Kategorisierungsregeln</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style id="dynamic-theme">/* Theme variables loaded from API */</style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img src="favicon.png" alt="FiniA Logo" class="header-logo">
    <div class="header-content">
      <h1>FiniA - Finanzverwaltung</h1>
      <div id="top-nav"></div>
    </div>
  </header>

  <div class="container">
    <div class="content-split">
      <!-- Left Pane: Rule List -->
      <div class="list-pane">
        <div class="search-bar">
          <select id="accountFilter" class="input-sm" onchange="filterByAccount()">
            <option value="">-- Alle Konten --</option>
          </select>
          <button class="btn" onclick="loadRules()">Aktualisieren</button>
          <button class="btn btn-secondary" onclick="resetRuleFilter()">Zurücksetzen</button>
          <button class="btn" onclick="createNewRule()">+ Neue Regel</button>
        </div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="loadingIndicator" class="loading">Lade Regeln...</div>
        <table class="transactions-table" id="rulesTable" style="display: none; table-layout: fixed;">
          <colgroup>
            <col style="width: 15%;">   <!-- Konto -->
            <col style="width: 25%;">   <!-- Spalte -->
            <col style="width: 35%;">   <!-- Regel -->
            <col style="width: 15%;">   <!-- Kategorie -->
            <col style="width: 10%;">   <!-- Priorität -->
          </colgroup>
          <thead>
            <tr>
              <th>Konto</th>
              <th>Spalte</th>
              <th>Regel</th>
              <th>Kategorie</th>
              <th style="text-align: center;">Prio</th>
            </tr>
          </thead>
          <tbody id="rulesBody"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
      </div>

      <!-- Right Pane: Rule Details -->
      <div class="detail-pane">
        <div id="detailsPanel" class="details-panel" style="display: none;">
          
          <!-- Rule Info Section -->
          <div class="details-header">
            <h3>Kategorisierungsregel</h3>
          </div>
          
          <div class="details-section">
            <div class="form-group">
              <label for="ruleAccount">Konto:</label>
              <select id="ruleAccount" class="input-sm" onchange="onRuleChange()">
                <option value="">-- Konto wählen --</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="ruleColumn">Spalte durchsuchen:</label>
              <select id="ruleColumn" class="input-sm" onchange="onRuleChange()">
                <option value="description">Beschreibung</option>
                <option value="recipientApplicant">Empfänger/Auftraggeber</option>
                <option value="amount">Betrag</option>
                <option value="iban">IBAN</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="ruleType">Regeltyp:</label>
              <select id="ruleType" class="input-sm" onchange="onRuleTypeChange()">
                <option value="contains">Enthält (Contains)</option>
                <option value="equals">Ist gleich (Equals)</option>
                <option value="startsWith">Beginnt mit (Starts With)</option>
                <option value="endsWith">Endet mit (Ends With)</option>
                <option value="regex">Regulärer Ausdruck (Regex)</option>
                <option value="amountRange">Betragsbereich (Amount Range)</option>
              </select>
            </div>
          </div>

          <!-- Rule Value Section -->
          <div class="details-section" id="valueSection">
            <div class="form-group">
              <label for="ruleValue">Suchtext/Muster:</label>
              <input type="text" id="ruleValue" class="input-sm" placeholder="z.B. Amazon, Miete, etc." onchange="onRuleChange()">
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="ruleCaseSensitive" onchange="onRuleChange()">
                Groß-/Kleinschreibung beachten
              </label>
            </div>
          </div>

          <!-- Amount Range Section (hidden by default) -->
          <div class="details-section" id="amountSection" style="display: none;">
            <div class="form-group">
              <label for="ruleMinAmount">Mindestbetrag:</label>
              <input type="number" id="ruleMinAmount" class="input-sm" step="0.01" placeholder="0.00" onchange="onRuleChange()">
            </div>
            
            <div class="form-group">
              <label for="ruleMaxAmount">Höchstbetrag:</label>
              <input type="number" id="ruleMaxAmount" class="input-sm" step="0.01" placeholder="1000.00" onchange="onRuleChange()">
            </div>
          </div>

          <!-- Category & Priority Section -->
          <div class="details-section">
            <div class="form-group">
              <label for="ruleCategory">Kategorie:</label>
              <select id="ruleCategory" class="input-sm" onchange="onRuleChange()">
                <option value="">-- Kategorie wählen --</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="rulePriority">Priorität (höher = zuerst):</label>
              <input type="number" id="rulePriority" class="input-sm" min="1" max="1000" value="1" onchange="onRuleChange()">
            </div>
          </div>

          <!-- Test Section -->
          <div class="details-section">
            <div class="details-header">
              <h3>Regel testen</h3>
            </div>
            <div class="form-group">
              <label for="testDescription">Test-Beschreibung:</label>
              <input type="text" id="testDescription" class="input-sm" placeholder="z.B. Zahlung an Amazon GmbH">
            </div>
            
            <div class="form-group">
              <label for="testRecipient">Test-Empfänger:</label>
              <input type="text" id="testRecipient" class="input-sm" placeholder="Optional">
            </div>
            
            <div class="form-group">
              <label for="testAmount">Test-Betrag:</label>
              <input type="number" id="testAmount" class="input-sm" step="0.01" placeholder="Optional">
            </div>
            
            <button class="btn btn-secondary" onclick="testRule()">Regel testen</button>
            <div id="testResult" style="margin-top: 8px; display: none;">
              <span id="testResultText"></span>
            </div>
          </div>

          <!-- Toolbar -->
          <div class="details-toolbar" style="margin-top: 24px;">
            <div style="display:flex; gap:8px;">
              <button class="btn" onclick="saveRule()" id="saveButton">Speichern</button>
              <button class="btn btn-danger" onclick="deleteRule()" id="deleteButton">Löschen</button>
              <button class="btn btn-secondary" onclick="clearRuleForm()">Neue Regel</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script src="utils.js"></script>
  <script src="category_automation.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadTopNav('category-automation');
    });
  </script>
</body>
</html>
